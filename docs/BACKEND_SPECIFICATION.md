# Backend Specification for Welsh Mutation Trainer

## Overview

This document provides detailed technical specifications for the backend API and database that will support both the web and Android versions of the Welsh Mutation Trainer application.

## Architecture

### Technology Stack

**Recommended Stack (Node.js):**
- **Runtime**: Node.js 18+ LTS
- **Framework**: Express.js 4.x
- **Database**: PostgreSQL 14+
- **ORM**: Sequelize or Prisma
- **Authentication**: JWT (jsonwebtoken)
- **Password Hashing**: bcrypt
- **Validation**: joi or express-validator
- **Email**: nodemailer or SendGrid
- **File Storage**: AWS S3 or local filesystem
- **Logging**: winston
- **Testing**: Jest + supertest
- **Documentation**: Swagger/OpenAPI

**Alternative Stack (Python):**
- **Framework**: FastAPI 0.100+
- **Database**: PostgreSQL 14+
- **ORM**: SQLAlchemy 2.0
- **Authentication**: python-jose (JWT)
- **Password Hashing**: passlib with bcrypt
- **Validation**: Pydantic (built-in with FastAPI)
- **Email**: FastAPI-Mail
- **Testing**: pytest
- **Documentation**: Auto-generated by FastAPI

### Deployment Architecture

```
                          ┌─────────────────┐
                          │   Load Balancer │
                          └────────┬────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
            ┌───────▼────────┐          ┌────────▼────────┐
            │  API Server 1   │          │  API Server 2   │
            │  (Docker)       │          │  (Docker)       │
            └───────┬─────────┘          └────────┬────────┘
                    │                             │
                    └──────────────┬──────────────┘
                                   │
                        ┌──────────▼──────────┐
                        │   PostgreSQL        │
                        │   (Primary DB)      │
                        └─────────────────────┘
                                   │
                        ┌──────────▼──────────┐
                        │   Redis Cache       │
                        │   (Optional)        │
                        └─────────────────────┘
```

## Database Schema

### Users Table
```sql
CREATE TABLE users (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    password_hash VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    preferred_language VARCHAR(2) DEFAULT 'en' CHECK (preferred_language IN ('en', 'cy')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    is_admin BOOLEAN DEFAULT FALSE
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
```

### Cards Table
```sql
CREATE TABLE cards (
    card_id VARCHAR(50) PRIMARY KEY,
    rule_family VARCHAR(50) NOT NULL, -- 'Soft', 'Aspirate', 'Nasal', 'None'
    rule_category VARCHAR(100), -- 'Article', 'Preposition', 'Adjective+Noun', etc.
    trigger VARCHAR(100),
    trigger_canonical VARCHAR(100),
    base_word VARCHAR(100) NOT NULL,
    word_category VARCHAR(50), -- 'noun-fem', 'noun-masc', 'adj', etc.
    before_text TEXT, -- Text before the blank
    after_text TEXT, -- Text after the blank
    answer VARCHAR(100) NOT NULL, -- The mutated form
    outcome VARCHAR(10) NOT NULL, -- 'SM', 'AM', 'NM', 'NONE'
    explanation_en TEXT,
    explanation_cy TEXT,
    translation TEXT,
    difficulty_level INTEGER DEFAULT 1, -- 1-5 scale
    source_file VARCHAR(100), -- 'cards.csv', 'prep.csv', etc.
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_cards_rule_family ON cards(rule_family);
CREATE INDEX idx_cards_rule_category ON cards(rule_category);
CREATE INDEX idx_cards_trigger_canonical ON cards(trigger_canonical);
CREATE INDEX idx_cards_outcome ON cards(outcome);
CREATE INDEX idx_cards_difficulty ON cards(difficulty_level);
```

### User Progress Table
```sql
CREATE TABLE user_progress (
    progress_id SERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    card_id VARCHAR(50) NOT NULL REFERENCES cards(card_id) ON DELETE CASCADE,
    leitner_box INTEGER DEFAULT 1 CHECK (leitner_box BETWEEN 1 AND 5),
    times_seen INTEGER DEFAULT 0,
    times_correct INTEGER DEFAULT 0,
    times_incorrect INTEGER DEFAULT 0,
    last_seen_at TIMESTAMP,
    next_review_at TIMESTAMP, -- Calculated based on leitner_box
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, card_id)
);

CREATE INDEX idx_progress_user ON user_progress(user_id);
CREATE INDEX idx_progress_card ON user_progress(card_id);
CREATE INDEX idx_progress_next_review ON user_progress(next_review_at);
CREATE INDEX idx_progress_leitner_box ON user_progress(leitner_box);
```

### Sessions Table
```sql
CREATE TABLE sessions (
    session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    start_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    end_time TIMESTAMP,
    total_cards INTEGER DEFAULT 0,
    correct_count INTEGER DEFAULT 0,
    accuracy_percentage DECIMAL(5, 2), -- Calculated: (correct_count / total_cards) * 100
    best_streak INTEGER DEFAULT 0,
    mode VARCHAR(20) CHECK (mode IN ('random', 'smart')),
    filter_snapshot JSONB, -- Store applied filters as JSON
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_sessions_start_time ON sessions(start_time);
```

### Session Attempts Table
```sql
CREATE TABLE session_attempts (
    attempt_id SERIAL PRIMARY KEY,
    session_id UUID NOT NULL REFERENCES sessions(session_id) ON DELETE CASCADE,
    card_id VARCHAR(50) NOT NULL REFERENCES cards(card_id) ON DELETE CASCADE,
    user_answer VARCHAR(100),
    was_correct BOOLEAN NOT NULL,
    used_hint BOOLEAN DEFAULT FALSE,
    used_reveal BOOLEAN DEFAULT FALSE,
    skipped BOOLEAN DEFAULT FALSE,
    time_spent_seconds INTEGER, -- Time spent on this card
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_attempts_session ON session_attempts(session_id);
CREATE INDEX idx_attempts_card ON session_attempts(card_id);
CREATE INDEX idx_attempts_timestamp ON session_attempts(timestamp);
```

### User Preferences Table
```sql
CREATE TABLE user_preferences (
    user_id UUID PRIMARY KEY REFERENCES users(user_id) ON DELETE CASCADE,
    default_practice_mode VARCHAR(20) DEFAULT 'smart' CHECK (default_practice_mode IN ('random', 'smart')),
    language VARCHAR(2) DEFAULT 'en' CHECK (language IN ('en', 'cy')),
    audio_enabled BOOLEAN DEFAULT TRUE,
    notifications_enabled BOOLEAN DEFAULT TRUE,
    notification_time TIME DEFAULT '09:00:00', -- Daily reminder time
    theme VARCHAR(10) DEFAULT 'light' CHECK (theme IN ('light', 'dark', 'system')),
    cards_per_session INTEGER DEFAULT 20,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Email Verification Tokens Table
```sql
CREATE TABLE email_verification_tokens (
    token VARCHAR(255) PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_email_tokens_user ON email_verification_tokens(user_id);
CREATE INDEX idx_email_tokens_expires ON email_verification_tokens(expires_at);
```

### Password Reset Tokens Table
```sql
CREATE TABLE password_reset_tokens (
    token VARCHAR(255) PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    expires_at TIMESTAMP NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_reset_tokens_user ON password_reset_tokens(user_id);
CREATE INDEX idx_reset_tokens_expires ON password_reset_tokens(expires_at);
```

## API Endpoints

### Authentication Endpoints

#### POST /api/auth/register
**Description**: Create a new user account

**Request Body**:
```json
{
  "email": "user@example.com",
  "password": "SecurePassword123!",
  "displayName": "John Doe",
  "preferredLanguage": "en"
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "message": "User registered successfully. Please check your email to verify your account.",
  "data": {
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "displayName": "John Doe"
  }
}
```

**Validations**:
- Email must be valid format
- Password must be at least 8 characters with uppercase, lowercase, and number
- Email must not already exist

---

#### POST /api/auth/login
**Description**: Authenticate user and return JWT token

**Request Body**:
```json
{
  "email": "user@example.com",
  "password": "SecurePassword123!"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "userId": "550e8400-e29b-41d4-a716-446655440000",
      "email": "user@example.com",
      "displayName": "John Doe",
      "preferredLanguage": "en",
      "emailVerified": true
    }
  }
}
```

**Error Response** (401 Unauthorized):
```json
{
  "success": false,
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "Invalid email or password"
  }
}
```

---

#### POST /api/auth/logout
**Description**: Invalidate user's token (add to blacklist)

**Headers**: 
```
Authorization: Bearer <token>
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

---

#### POST /api/auth/refresh
**Description**: Refresh expired JWT token

**Request Body**:
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

---

#### POST /api/auth/forgot-password
**Description**: Send password reset email

**Request Body**:
```json
{
  "email": "user@example.com"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "If an account exists with that email, a password reset link has been sent."
}
```

---

#### POST /api/auth/reset-password
**Description**: Reset password using token

**Request Body**:
```json
{
  "token": "reset-token-from-email",
  "newPassword": "NewSecurePassword123!"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Password reset successfully"
}
```

---

#### GET /api/auth/verify-email?token=<token>
**Description**: Verify user email address

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Email verified successfully"
}
```

---

### User Profile Endpoints

#### GET /api/users/me
**Description**: Get current user profile

**Headers**: 
```
Authorization: Bearer <token>
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "displayName": "John Doe",
    "preferredLanguage": "en",
    "emailVerified": true,
    "createdAt": "2024-01-15T10:30:00Z",
    "lastLogin": "2024-02-04T14:00:00Z"
  }
}
```

---

#### PUT /api/users/me
**Description**: Update user profile

**Headers**: 
```
Authorization: Bearer <token>
```

**Request Body**:
```json
{
  "displayName": "Jane Doe",
  "preferredLanguage": "cy"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Profile updated successfully",
  "data": {
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "displayName": "Jane Doe",
    "preferredLanguage": "cy"
  }
}
```

---

#### DELETE /api/users/me
**Description**: Delete user account

**Headers**: 
```
Authorization: Bearer <token>
```

**Request Body**:
```json
{
  "password": "SecurePassword123!",
  "confirmation": "DELETE"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Account deleted successfully"
}
```

---

#### GET /api/users/me/stats
**Description**: Get comprehensive user statistics

**Headers**: 
```
Authorization: Bearer <token>
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "overall": {
      "totalCardsAttempted": 452,
      "totalCorrect": 368,
      "totalIncorrect": 84,
      "overallAccuracy": 81.42,
      "longestStreak": 23,
      "totalPracticeDays": 15,
      "currentDayStreak": 3
    },
    "byMutationType": [
      { "family": "Soft", "attempted": 200, "correct": 170, "accuracy": 85 },
      { "family": "Aspirate", "attempted": 120, "correct": 90, "accuracy": 75 },
      { "family": "Nasal", "attempted": 80, "correct": 65, "accuracy": 81.25 },
      { "family": "None", "attempted": 52, "correct": 43, "accuracy": 82.69 }
    ],
    "byCategory": [
      { "category": "Article", "attempted": 150, "correct": 130, "accuracy": 86.67 },
      { "category": "Preposition", "attempted": 100, "correct": 75, "accuracy": 75 }
    ],
    "masteryDistribution": {
      "box1": 45,
      "box2": 78,
      "box3": 120,
      "box4": 95,
      "box5": 62
    },
    "recentSessions": [
      {
        "sessionId": "...",
        "date": "2024-02-04",
        "cards": 25,
        "accuracy": 84,
        "mode": "smart"
      }
    ]
  }
}
```

---

### Cards Endpoints

#### GET /api/cards
**Description**: Get cards with optional filtering

**Headers**: 
```
Authorization: Bearer <token>
```

**Query Parameters**:
- `family` (optional): Filter by mutation type (Soft, Aspirate, Nasal, None) - comma-separated
- `category` (optional): Filter by grammar category - comma-separated
- `trigger` (optional): Filter by trigger word (canonical)
- `outcome` (optional): Filter by outcome (SM, AM, NM, NONE) - comma-separated
- `difficulty` (optional): Filter by difficulty level (1-5)
- `limit` (optional): Number of results (default: 100, max: 500)
- `offset` (optional): Pagination offset (default: 0)

**Example**: `/api/cards?family=Soft,Aspirate&category=Article&limit=50`

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "cards": [
      {
        "cardId": "c000001",
        "ruleFamily": "Soft",
        "ruleCategory": "Adjective+Noun",
        "trigger": "trefn",
        "triggerCanonical": "trefn",
        "baseWord": "penodol",
        "wordCategory": "adj",
        "beforeText": "Mae trefn",
        "afterText": "ar gyfer rheoli diogelwch",
        "answer": "benodol",
        "outcome": "SM",
        "explanationEn": "In Welsh, an adjective soft-mutates after a feminine singular noun...",
        "explanationCy": "Yn Gymraeg, mae ansoddair yn treiglo'n feddal ar ôl enw benywaidd unigol...",
        "translation": "There is a specific order for managing security",
        "difficultyLevel": 2
      }
    ],
    "pagination": {
      "total": 1000,
      "limit": 50,
      "offset": 0,
      "hasMore": true
    }
  }
}
```

---

#### GET /api/cards/:cardId
**Description**: Get specific card details

**Headers**: 
```
Authorization: Bearer <token>
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "cardId": "c000001",
    "ruleFamily": "Soft",
    "ruleCategory": "Adjective+Noun",
    "trigger": "trefn",
    "baseWord": "penodol",
    "answer": "benodol",
    "explanationEn": "...",
    "explanationCy": "...",
    "translation": "...",
    "userProgress": {
      "leitnerBox": 3,
      "timesSeen": 5,
      "timesCorrect": 4,
      "timesIncorrect": 1,
      "lastSeenAt": "2024-02-03T15:30:00Z"
    }
  }
}
```

---

#### GET /api/cards/random
**Description**: Get random card(s) based on filters

**Headers**: 
```
Authorization: Bearer <token>
```

**Query Parameters**:
- Same as GET /api/cards
- `count` (optional): Number of cards to return (default: 1, max: 50)

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "cards": [
      {
        "cardId": "c000042",
        ...
      }
    ]
  }
}
```

---

#### GET /api/cards/next-smart
**Description**: Get next card(s) using Leitner spaced repetition

**Headers**: 
```
Authorization: Bearer <token>
```

**Query Parameters**:
- Same filtering as GET /api/cards
- `count` (optional): Number of cards (default: 1, max: 50)

**Algorithm**:
1. From filtered cards, get user's progress
2. Prioritize cards due for review (next_review_at <= NOW)
3. Weight by Leitner box: Box 1 (50%), Box 2 (25%), Box 3 (15%), Box 4 (7%), Box 5 (3%)
4. Include new cards (not yet seen) with Box 1 weight
5. Return weighted random selection

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "cards": [
      {
        "cardId": "c000123",
        "leitnerBox": 1,
        "isDueForReview": true,
        ...
      }
    ]
  }
}
```

---

### User Progress Endpoints

#### GET /api/progress
**Description**: Get user's progress for all cards

**Headers**: 
```
Authorization: Bearer <token>
```

**Query Parameters**:
- `limit` (optional): Number of results (default: 100)
- `offset` (optional): Pagination offset

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "progress": [
      {
        "cardId": "c000001",
        "leitnerBox": 3,
        "timesSeen": 5,
        "timesCorrect": 4,
        "timesIncorrect": 1,
        "lastSeenAt": "2024-02-03T15:30:00Z",
        "nextReviewAt": "2024-02-06T15:30:00Z"
      }
    ],
    "pagination": {
      "total": 400,
      "limit": 100,
      "offset": 0
    }
  }
}
```

---

#### GET /api/progress/:cardId
**Description**: Get user's progress for specific card

**Headers**: 
```
Authorization: Bearer <token>
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "cardId": "c000001",
    "leitnerBox": 3,
    "timesSeen": 5,
    "timesCorrect": 4,
    "timesIncorrect": 1,
    "accuracy": 80.0,
    "lastSeenAt": "2024-02-03T15:30:00Z",
    "nextReviewAt": "2024-02-06T15:30:00Z"
  }
}
```

---

#### POST /api/progress/:cardId
**Description**: Update progress for a card after user attempts it

**Headers**: 
```
Authorization: Bearer <token>
```

**Request Body**:
```json
{
  "correct": true,
  "timeSpentSeconds": 12,
  "usedHint": false,
  "usedReveal": false,
  "skipped": false
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Progress updated",
  "data": {
    "cardId": "c000001",
    "leitnerBox": 4,
    "nextReviewAt": "2024-02-10T15:30:00Z"
  }
}
```

**Logic**:
- If correct: Move to next box (max 5)
- If incorrect: Reset to box 1
- Calculate next_review_at based on box:
  - Box 1: Review immediately (same day)
  - Box 2: Review in 1 day
  - Box 3: Review in 3 days
  - Box 4: Review in 7 days
  - Box 5: Review in 14 days

---

#### DELETE /api/progress
**Description**: Reset all user progress

**Headers**: 
```
Authorization: Bearer <token>
```

**Request Body**:
```json
{
  "confirmation": "RESET"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "All progress reset successfully"
}
```

---

### Sessions Endpoints

#### POST /api/sessions
**Description**: Start a new practice session

**Headers**: 
```
Authorization: Bearer <token>
```

**Request Body**:
```json
{
  "mode": "smart",
  "filters": {
    "families": ["Soft", "Aspirate"],
    "categories": ["Article"],
    "triggers": ["y"]
  }
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "data": {
    "sessionId": "650e8400-e29b-41d4-a716-446655440000",
    "startTime": "2024-02-04T14:00:00Z",
    "mode": "smart",
    "filters": { ... }
  }
}
```

---

#### GET /api/sessions/:sessionId
**Description**: Get session details

**Headers**: 
```
Authorization: Bearer <token>
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "sessionId": "650e8400-e29b-41d4-a716-446655440000",
    "startTime": "2024-02-04T14:00:00Z",
    "endTime": "2024-02-04T14:25:00Z",
    "totalCards": 25,
    "correctCount": 21,
    "accuracy": 84.0,
    "bestStreak": 12,
    "mode": "smart",
    "attempts": [
      {
        "cardId": "c000001",
        "userAnswer": "benodol",
        "wasCorrect": true,
        "timeSpentSeconds": 15
      }
    ]
  }
}
```

---

#### PUT /api/sessions/:sessionId
**Description**: Update session (typically to mark as ended)

**Headers**: 
```
Authorization: Bearer <token>
```

**Request Body**:
```json
{
  "endTime": "2024-02-04T14:25:00Z",
  "totalCards": 25,
  "correctCount": 21,
  "bestStreak": 12
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Session updated",
  "data": {
    "sessionId": "650e8400-e29b-41d4-a716-446655440000",
    "accuracy": 84.0
  }
}
```

---

#### POST /api/sessions/:sessionId/attempts
**Description**: Log a card attempt in a session

**Headers**: 
```
Authorization: Bearer <token>
```

**Request Body**:
```json
{
  "cardId": "c000001",
  "userAnswer": "benodol",
  "wasCorrect": true,
  "usedHint": false,
  "usedReveal": false,
  "skipped": false,
  "timeSpentSeconds": 15
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "data": {
    "attemptId": 12345,
    "sessionId": "650e8400-e29b-41d4-a716-446655440000",
    "cardId": "c000001",
    "timestamp": "2024-02-04T14:05:00Z"
  }
}
```

---

#### GET /api/sessions
**Description**: Get user's session history

**Headers**: 
```
Authorization: Bearer <token>
```

**Query Parameters**:
- `limit` (optional): Number of sessions (default: 20, max: 100)
- `offset` (optional): Pagination offset

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "sessions": [
      {
        "sessionId": "650e8400-e29b-41d4-a716-446655440000",
        "startTime": "2024-02-04T14:00:00Z",
        "endTime": "2024-02-04T14:25:00Z",
        "totalCards": 25,
        "accuracy": 84.0,
        "mode": "smart"
      }
    ],
    "pagination": {
      "total": 45,
      "limit": 20,
      "offset": 0
    }
  }
}
```

---

### Preferences Endpoints

#### GET /api/preferences
**Description**: Get user preferences

**Headers**: 
```
Authorization: Bearer <token>
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "defaultPracticeMode": "smart",
    "language": "en",
    "audioEnabled": true,
    "notificationsEnabled": true,
    "notificationTime": "09:00:00",
    "theme": "light",
    "cardsPerSession": 20
  }
}
```

---

#### PUT /api/preferences
**Description**: Update user preferences

**Headers**: 
```
Authorization: Bearer <token>
```

**Request Body**:
```json
{
  "defaultPracticeMode": "smart",
  "language": "cy",
  "audioEnabled": false,
  "theme": "dark"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Preferences updated",
  "data": {
    "defaultPracticeMode": "smart",
    "language": "cy",
    "audioEnabled": false,
    "theme": "dark"
  }
}
```

---

### Sync Endpoint

#### POST /api/sync
**Description**: Batch sync progress and session data (for offline support)

**Headers**: 
```
Authorization: Bearer <token>
```

**Request Body**:
```json
{
  "lastSyncTimestamp": "2024-02-03T10:00:00Z",
  "progressUpdates": [
    {
      "cardId": "c000001",
      "leitnerBox": 3,
      "timesSeen": 5,
      "timesCorrect": 4,
      "lastSeenAt": "2024-02-04T14:00:00Z"
    }
  ],
  "sessionAttempts": [
    {
      "tempId": "local-123",
      "cardId": "c000001",
      "wasCorrect": true,
      "timestamp": "2024-02-04T14:05:00Z"
    }
  ]
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "syncTimestamp": "2024-02-04T14:10:00Z",
    "conflicts": [],
    "synced": {
      "progressUpdates": 1,
      "sessionAttempts": 1
    }
  }
}
```

---

## Security & Authentication

### JWT Structure
```json
{
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "iat": 1707058800,
  "exp": 1707145200
}
```

### Token Expiration
- Access Token: 1 hour
- Refresh Token: 7 days

### Password Requirements
- Minimum 8 characters
- At least one uppercase letter
- At least one lowercase letter
- At least one number
- Special characters encouraged but not required

### Rate Limiting
- Authentication endpoints: 5 requests per minute per IP
- General API: 100 requests per minute per user
- Card fetching: 500 requests per minute per user

### CORS Configuration
- Allow origins: Web app domain, localhost (dev)
- Allow methods: GET, POST, PUT, DELETE
- Allow headers: Authorization, Content-Type

## Data Import

### CSV to Database Import Script

**Requirements**:
- Parse existing CSV files (cards.csv, article-sylfaen.csv, prep.csv)
- Transform data to match database schema
- Generate card_id if missing (use row number with prefix)
- Set difficulty_level based on heuristics
- Track source_file for each card

**Script Flow**:
1. Read CSV file
2. Parse and validate each row
3. Transform to database format
4. Insert with conflict handling (ON CONFLICT DO UPDATE)
5. Log imported/updated/skipped counts

## Error Handling

### Standard Error Response Format
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable error message",
    "details": {} // Optional additional context
  }
}
```

### Common Error Codes
- `INVALID_CREDENTIALS` - Wrong email/password
- `UNAUTHORIZED` - Missing or invalid token
- `FORBIDDEN` - User doesn't have access
- `NOT_FOUND` - Resource doesn't exist
- `VALIDATION_ERROR` - Invalid request data
- `DUPLICATE_RESOURCE` - Resource already exists (e.g., email)
- `SERVER_ERROR` - Internal server error
- `RATE_LIMIT_EXCEEDED` - Too many requests

## Performance Optimization

### Caching Strategy
- Cache cards data (1 hour TTL)
- Cache user preferences (5 minutes TTL)
- Invalidate on updates

### Database Optimization
- Indexes on frequently queried columns
- Connection pooling (max 20 connections)
- Query timeout: 30 seconds
- Use prepared statements

### Response Optimization
- Gzip compression
- Pagination for large datasets
- Partial response fields (optional query param)

## Monitoring & Logging

### Metrics to Track
- Request rate per endpoint
- Average response time
- Error rate
- Active users
- Database query performance
- API endpoint usage

### Logging Levels
- ERROR: Application errors, failed requests
- WARN: Deprecated API usage, rate limits hit
- INFO: User actions (login, session start)
- DEBUG: Detailed request/response data

## Deployment

### Environment Variables
```
# Database
DATABASE_URL=postgresql://user:password@host:5432/dbname
DATABASE_POOL_SIZE=20

# JWT
JWT_SECRET=your-secret-key-here
JWT_EXPIRES_IN=1h
REFRESH_TOKEN_EXPIRES_IN=7d

# Email
EMAIL_SERVICE=smtp
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=noreply@example.com
SMTP_PASSWORD=password
FROM_EMAIL=noreply@example.com

# Application
NODE_ENV=production
PORT=3000
API_BASE_URL=https://api.example.com
WEB_APP_URL=https://app.example.com

# CORS
ALLOWED_ORIGINS=https://app.example.com,https://www.example.com

# Rate Limiting
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=100

# Logging
LOG_LEVEL=info
```

### Docker Configuration
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["node", "server.js"]
```

### Health Check Endpoint
```
GET /api/health
Response: { "status": "ok", "timestamp": "2024-02-04T14:00:00Z", "database": "connected" }
```

## Testing

### Test Coverage Requirements
- Unit tests: >80% coverage
- Integration tests for all API endpoints
- End-to-end tests for critical user flows

### Test Data
- Seed database with sample cards
- Create test users
- Mock external services (email)

## Future Enhancements

### Phase 2 Features
- Admin dashboard for content management
- Analytics dashboard
- Content recommendations based on user performance
- Gamification (achievements, leaderboards)
- Social features (friend challenges)

### Scalability Considerations
- Horizontal scaling with load balancer
- Read replicas for database
- Redis for session storage and caching
- CDN for static assets
- Message queue for async tasks (email sending)

---

This specification provides a complete foundation for building a robust, scalable backend that supports both web and mobile applications for the Welsh Mutation Trainer.
